<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>AI Marketing Assistant</title>

<style>
body {
    background:#0f172a;
    font-family: Arial, sans-serif;
    color:white;
}

.container {
    width:600px;
    margin:80px auto;
    background:#1e293b;
    padding:25px;
    border-radius:20px;
    display:flex;
    flex-direction:column;
}

.chat {
    height:380px;
    overflow-y:auto;
    background:#020617;
    padding:15px;
    border-radius:15px;
    white-space:pre-wrap;

    display:none;
    opacity:0;
    transition: opacity .25s ease;
}

.chat.visible {
    display:block;
    opacity:1;
}

.message {
    margin-bottom:16px;
}

.user {
    color:#38bdf8;
    font-weight:bold;
}

.ai {
    color:#e5e7eb;
    line-height:1.5;
}

.actions {
    display:flex;
    gap:8px;
    margin-bottom:20px;
}

.action-btn {
    background:#1e293b;
    border:none;
    color:#94a3b8;
    cursor:pointer;
    border-radius:6px;
    padding:6px 12px;
    font-size:13px;
}

.action-btn.active {
    background:#22c55e;
    color:#020617;
}

.action-btn.disabled {
    opacity:0.4;
    cursor:not-allowed;
}

.input-area {
    margin-top:15px;
}

input, button {
    width:100%;
    padding:14px;
    border-radius:10px;
    border:none;
    font-size:16px;
    box-sizing:border-box;
}

button {
    margin-top:10px;
    background:#38bdf8;
    cursor:pointer;
}

button:disabled {
    opacity:0.6;
    cursor:not-allowed;
}

.controls {
    display:flex;
    gap:10px;
}
</style>
</head>

<body>

<div class="container">
    <h2>AI Marketing Assistant</h2>

    <div class="chat" id="chat"></div>

    <div class="input-area">
        <input id="product" placeholder="Введите товар" maxlength="300">
        <div class="controls">
            <button id="generateBtn">Generate</button>
            <button id="stopBtn">Stop</button>
        </div>
    </div>
</div>

<script>
let eventSource = null;

function formatText(text) {
    return text
        
        .replace(/Короткое описание\s*:?\s*/gi, "Короткое описание:\n")
        .replace(/5\s*преимуществ\s*:?\s*/gi, "\n\n5 преимуществ:\n")
        .replace(/2\s*слогана\s*:?\s*/gi, "\n\n2 слогана:\n")
        .replace(/Хештеги\s*:?\s*/gi, "\n\nХештеги:\n")

        
        .replace(/(\d+)\)/g, "\n$1)")

        
        .replace(/#/g, "\n#")

        
        .replace(/([a-zа-яё])([A-ZА-ЯЁ])/g, "$1 $2")

        
        .replace(/\n{3,}/g, "\n\n")

        .trim();
}

document.getElementById("generateBtn").onclick = generate;
document.getElementById("stopBtn").onclick = stop;

function generate() {
    const input = document.getElementById("product");
    const product = input.value.trim();
    if (!product) return;

    const chat = document.getElementById("chat");
    chat.classList.add("visible");

    input.value = "";

    const userMsg = document.createElement("div");
    userMsg.className = "message user";
    userMsg.innerText = "You: " + product;
    chat.appendChild(userMsg);

    const aiMsg = document.createElement("div");
    aiMsg.className = "message ai";
    aiMsg.innerText = "AI:\n";
    chat.appendChild(aiMsg);

    const actions = document.createElement("div");
    actions.className = "actions";
    actions.style.display = "none";

    const copyBtn = makeBtn("Copy", () => copyText(aiMsg, copyBtn));
    const likeBtn = makeVoteBtn("Helpful", actions);
    const dislikeBtn = makeVoteBtn("Not helpful", actions);
    const retryBtn = makeBtn("Try again", () => retry(product, retryBtn));

    actions.append(copyBtn, likeBtn, dislikeBtn, retryBtn);
    chat.appendChild(actions);

    document.getElementById("generateBtn").disabled = true;

    eventSource = new EventSource(
        "/generate?product=" + encodeURIComponent(product)
    );

   eventSource.onmessage = function (event) {
    aiMsg.innerText = formatText(aiMsg.innerText + event.data);
    chat.scrollTop = chat.scrollHeight;
};


    eventSource.onerror = () => {
        aiMsg.innerText = "AI:\n" + formatText(
            aiMsg.innerText.replace("AI:\n", "")
        );
        stop();
    };
}

function stop() {
    const btn = document.getElementById("generateBtn");

    if (eventSource) {
        eventSource.close();
        eventSource = null;
    }

    
    const actions = document.querySelectorAll(".actions");
    if (actions.length) {
        actions[actions.length - 1].style.display = "flex";
    }

    btn.disabled = false;
}


function makeBtn(text, fn) {
    const b = document.createElement("button");
    b.className = "action-btn";
    b.innerText = text;
    b.onclick = fn;
    return b;
}

function makeVoteBtn(icon, container) {
    const b = document.createElement("button");
    b.className = "action-btn";
    b.innerText = icon;
    b.onclick = () => {
        if (b.classList.contains("active")) return;
        b.classList.add("active");
        container.querySelectorAll(".action-btn").forEach(x => {
            if (x !== b && (x.innerText === "Helpful" || x.innerText === "Not helpful")) {
                x.classList.add("disabled");
                x.onclick = null;
            }
        });
    };
    return b;
}

function copyText(aiMsg, btn) {
    navigator.clipboard.writeText(
        aiMsg.innerText.replace("AI:\n", "")
    );
    btn.classList.add("active");
    setTimeout(() => btn.classList.remove("active"), 800);
}

function retry(product, btn) {
    
    btn.classList.add("active");

    setTimeout(() => {
        btn.classList.remove("active");
    }, 800);

    document.getElementById("product").value = product;
    generate();
}

</script>

</body>
</html>
